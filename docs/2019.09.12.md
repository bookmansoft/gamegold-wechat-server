# Remoting 机制说明

## 通讯的不同形式

Vallnet 平台架构中，所有非索引节点，以星状结构和索引节点相连
节点间远程通讯模式可以归纳为如下集中形式：

1. A节点和索引节点通讯：我们称之为上行通讯
2. 索引节点和A节点通讯：我们称之为下行通讯
3. A节点经由索引节点的路由功能，和B节点通讯：我们称之为漫游通讯

### 上行通讯

第一种情形，A节点访问索引节点 remote 控制器中的 newAttr 方法

```js
//通过上行通讯，A节点调用索引节点控制器方法 remote.newAttr ，更新索引服上的用户属性
await core.remoteCall('newAttr', {domain: user.domain, openid: user.openid, attr: attr});
```

第二种情形，A节点访问索引节点的 Service 方法

```js
//remoteService 借助 remoteCall 实现远程访问机制，并借助索引节点内置的 remote.service 方法，来访问索引服上的 Service 方法
//相当于先访问 remote.service , 借助该方法去访问服务 dailyactivity 的 getList 方法
await core.remoteService(`dailyactivity.getList`, []);
```

### 下行通讯

```js
//通过上行通讯，索引节点调用由si唯一标识的逻辑节点的控制器方法 remote.test
let si = {stype:'Wallet', sid:1};
await core.remoteCall('test', {}, null, si);
```

索引节点额外封装了控制器方法 remote.command ，可以通过控制台调用，对特定方法，在特定服务器或集群范围内执行，这是为了方便控制台程序的开发

### 漫游通讯

A节点调用B节点的控制器方法，借助了索引服的消息路由功能

```js
//remoteLogic 借助 remoteCall 实现远程访问机制，并借助索引节点内置的 remote.routeCommand 方法透明访问目标逻辑节点的控制器方法
await core.remoteLogic('cpStatus', {cp_id: cp.getAttr('cp_id'), cp_st: objData.cp_st}, {stype:'Wallet', sid:0});
```

## 通讯的安全机制

在 Remoting 机制中，核心函数 remoteCall 锁定了只能访问位于控制器 remote 中的方法，而 remote 强制接受中间件 authRemote 的安全审核

这样做的结果就是，将访问能力限制在了节点和节点之间，和C端完全隔离