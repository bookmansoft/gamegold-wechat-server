# 调测日志

## 游戏上链

为鸡小德游戏实现生态接口，以实现如下标准流程：
1. 在主网注册鸡小德游戏后，平台自动采集来自游戏生态接口的信息，包括游戏描述信息、商城道具信息
2. 在钱包中直接购买鸡小德游戏道具
3. 持钱包颁发的用户身份信息登录鸡小德游戏，对链上道具进行确权

需要解决的问题：
1. 上链道具的选购流程，如何与普通道具的选购流程融合？
2. 游戏金支付流程如何与原有的支付流程融合？
3. 上链道具的发放流程，如何与普通道具的发放流程融合？

## 鸡小德配置表实例解析

客户端配置表位于如下目录： resource/res/config/

1. 道具配置表 itemdata.json

```json
{
	"1001":{
		"id":1,
		"name":"itemdataname1",
		"pic":"suipian_jixiaode",
		"type":"C",
		"desc":"itemdatadesc1",
		"price":5000
	},
	"21001":{
		"id":1001,
		"name":"鸡小德",
		"pic":"",
		"type":"role",
		"desc":"",
		"price":0
	},
}
```

2. 角色配置表 roledata.json

```json
{
    "21001":                                //角色编号
    {
		"id":21001,                         //角色编号
		"pieceid":1001,                     //角色碎片编号
		"unlockskill1":[],                  //技能觉醒条件：逗分角色编号
		"unlockskill2":[21002],             //技能觉醒条件：逗分角色编号
		"unlockskill3":[21004],             //技能觉醒条件：逗分角色编号
		"isscene":0,                        //特殊场景
	},
}
```

表单中较难处理的是道具的复合索引字段，例如角色编号 21001 要能正确分解为类型 20000 和 索引 1001, 内部设计中，这个索引号又是该角色进阶材料的编号

## const 常量配置管理

系统目前的常量管理机制描述如下：
1. 将常量分为节点相关和节点无关两种体系，以应对当前框架多类型节点并行开发模式
2. 节点无关常量
	21. 可通过 facade.const 访问
	22. 框架通用常量定义于 Facade/CoreOfBase/enum.js 用户自定义常量位于 App/CoreOfBase/enum.js ，两者先后加载、汇总成节点无关常量集合
3. 节点相关常量
	31. 可通过 core.const 访问
	32. 节点相关常量通过 Facade/${CoreName}/enum.js 和 App/${CoreName}/enum.js 系列文件定义，系统按类继承树顺序加载，汇总成节点相关常量集合

上述机制可以应用于如下场景：

1. 使用框架内置常量
可直接通过门面对象实现： facade.const

2. 定义并使用节点无关常量
在 App/CoreOfBase/enum.js 内定义并输出自定义常量，注意同名自定义常量会覆盖框架内置常量
所有常量仍可通过访问门面对象实现： facade.const

3. 定义并使用节点相关常量
在 App/${CoreName}/enum.js 内定义并输出节点相关的自定义常量
可通过 core.const 访问上述常量

## 订单系统工作流程

### 持久化机制

由 buylogs (EntityType.BuyLog) 承担持久化任务

### 基本流程

1. 客户端购买VIP服务，或者购买众筹份额时，首先向服务端发起请求，服务端向微信发起预支付请求，如成功就创建订单，并将应答返回给客户端
2. 客户端发起微信支付，如果成功就会将结果提交给服务端，服务端收到后，将订单状态修订为"已支付-客户端"
3. 服务端收到微信支付回调，根据回调结果，将对应订单状态修改为"已确认"或"已取消"，如果是"已确认"，服务端着手兑付订单内容
4. 服务端定期对订单进行状态检测，对超过一定时间、状态仍旧为"已支付-客户端"的订单，发起主动查询，并相应修改订单状态

关于商品选购、订单和支付
1. 商品采用目录模式管理，每个商品需要明确标注上链与否，如果上链，还需要配置和上链相关的关联参数
2. 采用自动抽取技术，将上链商品单独抽取成列表，通过生态接口开放出去
3. 元宝购物走内部购物流程，如果所购物品中需要上链，还需要追加上链流程
4. 换购元宝流程按照外部购物流程执行
5. 游戏金支付、微信支付、支付宝支付走外部购物流程，如果所购物品中需要上链，还需要追加上链流程

### 应用场景

1. 玩家在游戏购物车界面生成并提交订单，游戏采用 Notify 模式通知主网，钱包收到通知后提醒用户，用户进入钱包、在消息中心界面完成支付、自动跳转游戏查收道具
2. 玩家在游戏购物车界面生成并提交订单，并立即跳转到钱包进行支付，支付后跳转回游戏、查收道具
3. 玩家在钱包购物车界面生成订单并立即支付，支付后跳转游戏、查收道具

## 程序结构调整记录

### CP表结构调整

CRM.Cp 表微调， cp_state 由原先单一整型数值，调整为复合状态字段
