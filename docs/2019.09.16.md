# 调测日志

## 游戏上链

为鸡小德游戏实现生态接口，以实现如下标准流程：
1. 在主网注册鸡小德游戏后，平台自动采集来自游戏生态接口的信息，包括游戏描述信息、商城道具信息
2. 在钱包中直接购买鸡小德游戏道具
3. 持钱包颁发的用户身份信息登录鸡小德游戏，对链上道具进行确权

需要解决的问题：
1. 上链道具的选购流程，如何与普通道具的选购流程融合？
2. 游戏金支付流程如何与原有的支付流程融合？
3. 上链道具的发放流程，如何与普通道具的发放流程融合？

### 生态接口

获取游戏基本描述信息。钱包会利用此接口，获取游戏描述信息，以及待售商品列表
`/info`

订单补提功能接口。钱包立即购流程会利用此接口提交订单，游戏服务端接收后缓存并返回成功应答，钱包收到应答后，会进一步执行支付流程
`/testnet/order/add`

```js
//首先校验用户身份信息，确保是合法传递的信息
//核对对应的本地用户是否已经存在
//查询订单，如果不存在则自动生成新的订单
```

订单完成回调功能接口。钱包执行支付后，游戏服务端在此端口上会收到主网广播的支付成功回调，验证通过后检索并执行订单内容
`/testnet/order/confirm`

### 钱包向游戏的跳转

钱包携带用户认证信息跳转游戏，游戏端负责解析/验证KYC信息，执行用户注册/登录操作，绑定用户确权地址

```js
//CP信息描述对象
let cp = {
	cpurl: '游戏注册的门户地址',
}
//钱包发放的用户认证信息描述对象
let auth = [
    'cid':		'游戏编码',
    'uid':		'用户编号',
    'addr':		'用户确权地址',
    'pubkey':	'确权地址公钥',
    'time':		'时间戳',
    'sig':		'数字指纹',
];

window.location.href = `${cp.cpurl}?kyc=${encodeURIComponent(JSON.stringify(auth))}`;
```

### 游戏向钱包的跳转

游戏向钱包跳转，可能携带二级界面地址/相关参数。为安全起见，钱包不会接收来自游戏的用户认证信息，而是独立执行注册/登录流程，然后在已鉴定身份基础上执行支付

```js
//设定钱包门户地址
let root = `http://h5.gamegold.xin`;

//方案一：跳转至钱包门户
window.location.href = root;

//方案二：跳转至钱包内部指定界面，本例为用户在游戏内生成订单后，携带订单信息跳转至钱包的订单支付界面
let order = {
	cid: 	'游戏编码',
	sn: 	'订单编号',
	price: 	'订单价格',
};
let path = encodeURIComponent(`/wallet/pay/${JSON.stringify(order)}`);
window.location.href = `${root}?path=${path}`;
```

## 订单系统工作流程

### 持久化机制

由 buylogs (EntityType.BuyLog) 承担持久化任务

### 基本流程

1. 客户端购买VIP服务，或者购买众筹份额时，首先向服务端发起请求，服务端向微信发起预支付请求，如成功就创建订单，并将应答返回给客户端
2. 客户端发起微信支付，如果成功就会将结果提交给服务端，服务端收到后，将订单状态修订为"已支付-客户端"
3. 服务端收到微信支付回调，根据回调结果，将对应订单状态修改为"已确认"或"已取消"，如果是"已确认"，服务端着手兑付订单内容
4. 服务端定期对订单进行状态检测，对超过一定时间、状态仍旧为"已支付-客户端"的订单，发起主动查询，并相应修改订单状态

关于商品选购、订单和支付
1. 商品采用目录模式管理，每个商品需要明确标注上链与否，如果上链，还需要配置和上链相关的关联参数
2. 采用自动抽取技术，将上链商品单独抽取成列表，通过生态接口开放出去
3. 元宝购物走内部购物流程，如果所购物品中需要上链，还需要追加上链流程
4. 换购元宝流程按照外部购物流程执行
5. 游戏金支付、微信支付、支付宝支付走外部购物流程，如果所购物品中需要上链，还需要追加上链流程

### 应用场景

支付系统处理的标的物包括订单(含单独道具)、游戏金，交易流程分为Notify和URLSchema、内购等多种模式，以下逐一论述：

一. 订单处理
1. Notify流程
	11. 玩家在游戏内的购物车界面，生成订单并提交
	12. 游戏以Notify模式广播至主网
	13. 主网通知钱包、钱包通知用户
	14. 用户进入钱包，在消息中心界面完成支付，手动或自动跳转至游戏查收物品
	15. 主网负责调用游戏的支付回调接口，游戏收到通知后兑付订单，对订单中的上链道具，执行打造相应道具、发送至用户钱包地址的附加流程
2. UrlSchema流程
	11. 玩家在游戏内的购物车界面，生成订单并提交
	12. 游戏以URLSchema模式，携带订单信息、跳转至钱包支付界面
	13. 用户在钱包内完成支付、自动跳转回游戏查收物品
	14. 主网负责调用游戏的支付回调接口，游戏收到通知后兑付订单，对订单中的上链道具，执行打造相应道具、发送至用户钱包地址的附加流程
3. 钱包内购
	11. 用户在钱包内的购物车界面，生成订单并提交至支付界面
	12. 用户在支付界面完成支付，手动或自动跳转至游戏查收物品
	13. 主网负责调用游戏的支付回调接口，游戏收到通知后兑付订单，对订单中的上链道具，执行打造相应道具、发送至用户钱包地址的附加流程
4. 游戏内购
	11. 用户在游戏内选取道具发起购买请求
	12. 用户利用法币或游戏内钻石完成支付
	13. 游戏直接兑付订单，对订单中的上链道具，执行打造相应道具、发送至用户钱包地址的附加流程

二. 游戏金处理
1. 游戏内购
	11. 游戏通过多种途径自行获取游戏金
	12. 用户在游戏内发起申购游戏金请求
	13. 用户利用法币或游戏内钻石完成支付. 兑换比例由厂商自行拟定，平台将提供一个参考价格
	14. 游戏将相应游戏金转账至用户钱包地址
2. 钱包内购
	11. 用户开通VIP服务
	12. 系统定期赠送小额游戏金，用户通过提取操作转至自己的钱包地址
3. 钱包换购
	11. 用户挂单请求用游戏金交换BTC，兑换比例自行指定
	12. 第三方用户使用BTC接单交换
4. 游戏金和游戏衔接的方式
    41. 新增一种货币来映射游戏金 
    42. 以游戏元宝直接映射游戏金，注意这种模式无法处理游戏元宝的存量部分
    43. 将原有游戏元宝、游戏捆绑元宝全部转换为游戏元宝，然后以游戏捆绑元宝映射游戏金

## 鸡小德配置表实例解析

客户端配置表位于如下目录： resource/res/config/

1. 道具配置表 itemdata.json

```json
{
	"1001":{
		"id":1,
		"name":"itemdataname1",
		"pic":"suipian_jixiaode",
		"type":"C",
		"desc":"itemdatadesc1",
		"price":5000
	},
	"21001":{
		"id":1001,
		"name":"鸡小德",
		"pic":"",
		"type":"role",
		"desc":"",
		"price":0
	},
}
```

2. 角色配置表 roledata.json

```json
{
    "21001":                                //角色编号
    {
		"id":21001,                         //角色编号
		"pieceid":1001,                     //角色碎片编号
		"unlockskill1":[],                  //技能觉醒条件：逗分角色编号
		"unlockskill2":[21002],             //技能觉醒条件：逗分角色编号
		"unlockskill3":[21004],             //技能觉醒条件：逗分角色编号
		"isscene":0,                        //特殊场景
	},
}
```

表单中较难处理的是道具的复合索引字段，例如角色编号 21001 要能正确分解为类型 20000 和 索引 1001, 内部设计中，这个索引号又是该角色进阶材料的编号

## const 常量配置管理

系统目前的常量管理机制描述如下：
1. 将常量分为节点相关和节点无关两种体系，以应对当前框架多类型节点并行开发模式
2. 节点无关常量
	21. 可通过 facade.const 访问
	22. 框架通用常量定义于 Facade/CoreOfBase/enum.js 用户自定义常量位于 App/CoreOfBase/enum.js ，两者先后加载、汇总成节点无关常量集合
3. 节点相关常量
	31. 可通过 core.const 访问
	32. 节点相关常量通过 Facade/${CoreName}/enum.js 和 App/${CoreName}/enum.js 系列文件定义，系统按类继承树顺序加载，汇总成节点相关常量集合

上述机制可以应用于如下场景：

1. 使用框架内置常量
可直接通过门面对象实现： facade.const

2. 定义并使用节点无关常量
在 App/CoreOfBase/enum.js 内定义并输出自定义常量，注意同名自定义常量会覆盖框架内置常量
所有常量仍可通过访问门面对象实现： facade.const

3. 定义并使用节点相关常量
在 App/${CoreName}/enum.js 内定义并输出节点相关的自定义常量
可通过 core.const 访问上述常量

## 程序结构调整记录

### CP表结构调整

CRM.Cp 表微调， cp_state 由原先单一整型数值，调整为复合状态字段
