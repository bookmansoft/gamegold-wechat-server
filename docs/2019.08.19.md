# 订单系统调测

订单流程描述如下：
1. 用户在游戏内下单，通过 sys.notify 向主网发送订单信息
2. 用户钱包收到来自主网的 notify/receive 消息，转化为邮件
3. 用户查看邮件列表，选取订单，通过 order.pay 指令进行支付
4. 用户钱包收到 order/pay 消息，确认订单已支付
```json
//order/pay: 订单支付成功通知
{
    "sum": "金额",
    "time": "时间",
    "uid": "用户编号",
    "addr": "用户地址",
    "gaddr": "推广员地址",
    "sn": "订单号",
    "cid": "厂商",
    "height": "高度",
    "confirm": "确认数，未上链为0",
}
```
5. 用户刷新邮件列表，将观察到订单变为"已确认"状态
6. 游戏特约全节点收到订单交易后，将调用游戏服务端的订单确认回调接口
7. 游戏服务端收到回调请求，向用户发送道具，同时将订单设置为"已确认"
8. 用户打开道具背包，将观察到新购买的道具

# 钱包调测

1. 新出现问题：用户默认地址收不到转账款

因为主网数据库经过清零处理，中台缓存的用户默认的 accaddr 和当前账户不匹配，清理用户数据、重新生成后正常

2. 转账后用户钱包没有实时收到通知

因为测试阶段，暂时屏蔽了账户变更通知(test only)，导致账户变化不及时。经去除相关 test only 设置，功能恢复正常

3. 用户在游戏商城内下单购买，转回钱包支付订单后，道具背包中没有收到相关道具

全节点没有配置特约CP编码，通过CRM系统注册会自动配置，单独测试Wallet系统时需要手工配置

4. 用户在游戏商城内下单购买，收到两份待支付订单的邮件

异步函数重入问题导致，已为事件句柄 receiveNotify 添加防重入机制

5. 支付一笔订单，得到两个甚至三个道具

游戏服支付回调接口未作去重处理，已添加相应去重代码